% parameters used[recording]=add_spike_to_recording(recording,500,-30);
% for 2017 11 17 0002N_truncated

% for 9/17 0003 use 500, .25 with highpass filtering recording.abf.CH1_patch = highpass(recording.abf.CH1_patch,100,10000);
% for 9/17 0004 use 500, .1 with highpass filtering recording.abf.CH1_patch = highpass(recording.abf.CH1_patch,100,10000);
% redid the above filtering on 9/22/2020: 175, .1 with highpass filtering recording.abf.CH1_patch = highpass(recording.abf.CH1_patch,10,10000);

% for 9/17 0006 use 500, .35 with highpass filtering recording.abf.CH1_patch = highpass(recording.abf.CH1_patch,10,10000);
% redid the above filtering on 9/22/2020: 150, .18 with highpass filtering recording.abf.CH1_patch = highpass(recording.abf.CH1_patch,2,10000);

% for 9/18 0007 use 250, 2.25 with no highpass filtering;
% for 9/18 0009 use 250, 1.2 with no highpass filtering;
% for 9/18 0010 use 100, .05 with no highpass filtering;
% for 9/18 0011 use 100, .05 with no highpass filtering;
% for 9/18 0011 redofilter use 100, .08 with no highpass filtering;

% for 9/19 0000 use 100, .2 with no highpass filtering
% for 9/19 0002 use 100, .4 with highpass filtering recording.abf.CH1_patch = highpass(recording.abf.CH1_patch,100,10000);

% for 09/02/2020 0001 use use 100, .15 with highpass filtering recording.abf.CH1_patch = highpass(recording.abf.CH1_patch,100,10000);

% for 09/09/2020 0000 use 500, .2 with highpass filtering recording.abf.CH1_patch = highpass(recording.abf.CH1_patch,100,10000);
% for 09/09/2020 0001 use 500, .2 with highpass filtering recording.abf.CH1_patch = highpass(recording.abf.CH1_patch,100,10000);
% for 09/14/2020 0001 use 200, .1 with highpass filtering recording.abf.CH1_patch = highpass(recording.abf.CH1_patch,10,10000);
% for 09/14/2020 0002 use  125, .1 with highpass filtering recording.abf.CH1_patch = highpass(recording.abf.CH1_patch,10,10000);
% for 09/14/2020 0003 use 175, .1 with highpass filtering recording.abf.CH1_patch = highpass(recording.abf.CH1_patch,10,10000);
% for 09/14/2020 0004 use 250, .275 with highpass filtering recording.abf.CH1_patch = highpass(recording.abf.CH1_patch,10,10000);
% for 09/15/2020 0000 use 250, 1.4 with highpass filtering recording.abf.CH1_patch = highpass(recording.abf.CH1_patch,10,10000);

% for 09/16/2020 0002 use 250, .2 with highpass filtering recording.abf.CH1_patch = highpass(recording.abf.CH1_patch,10,10000);
% for 09/16/2020 0003 use 250, .2 with highpass filtering recording.abf.CH1_patch = highpass(recording.abf.CH1_patch,10,10000);

% for 09/16/2020 0004 use 250, .2 with highpass filtering recording.abf.CH1_patch = highpass(recording.abf.CH1_patch,10,10000);
% for 09/16/2020 0005 use 250, .2 with highpass filtering recording.abf.CH1_patch = highpass(recording.abf.CH1_patch,10,10000);
% for 09/16/2020 0006 use 250, .2 with highpass filtering recording.abf.CH1_patch = highpass(recording.abf.CH1_patch,10,10000);

% for 09/17/2020 0000 use 250, .8 with highpass filtering recording.abf.CH1_patch = highpass(recording.abf.CH1_patch,10,10000);
% for 09/17/2020 0001 (this is from abf 0000 but the latter part of the recording -- needed different spike detection) use 250, .45 with highpass filtering recording.abf.CH1_patch = highpass(recording.abf.CH1_patch,10,10000);

% for 09/18/2020 0000 (this is from abf 0000 but the latter part of the recording -- needed different spike detection) use 100, .17 with highpass filtering recording.abf.CH1_patch = highpass(recording.abf.CH1_patch,10,10000);

% for 10/06/2020 0010 use 500, .2 with highpass filtering recording.abf.CH1_patch = highpass(recording.abf.CH1_patch,10,10000);
% for 10/07/2020 0000 use 250, 1.4 with highpass filtering recording.abf.CH1_patch = highpass(recording.abf.CH1_patch,10,10000);


% for 10/07/2020 0007 use 100, .25 with highpass filtering recording.abf.CH1_patch = highpass(recording.abf.CH1_patch,10,10000);
% for 10/07/2020 0008 use 100, .25 with highpass filtering recording.abf.CH1_patch = highpass(recording.abf.CH1_patch,10,10000);
% for 10/07/2020 0011 use 100, .25 with highpass filtering recording.abf.CH1_patch = highpass(recording.abf.CH1_patch,10,10000);
% for 10/07/2020 0018 use 100, .25 with highpass filtering recording.abf.CH1_patch = highpass(recording.abf.CH1_patch,10,10000);
% for 10/07/2020 0024 use 100, .25 with highpass filtering recording.abf.CH1_patch = highpass(recording.abf.CH1_patch,10,10000);


% for 10/12/2020 0000 use 100, .75 with highpass filtering recording.abf.CH1_patch = highpass(recording.abf.CH1_patch,10,10000);


% for 10/12/2020 0001 use 100, .25 with highpass filtering recording.abf.CH1_patch = highpass(recording.abf.CH1_patch,10,10000);
% for 10/12/2020 0002 use 100, .25 with highpass filtering recording.abf.CH1_patch = highpass(recording.abf.CH1_patch,10,10000);
% for 10/12/2020 0003 use 100, .25 with highpass filtering recording.abf.CH1_patch = highpass(recording.abf.CH1_patch,10,10000);

% for 10/13/2020 0004 use 100, 2.2 with highpass filtering recording.abf.CH1_patch = highpass(recording.abf.CH1_patch,10,10000);
% for 10/13/2020 0008 use 100, 2.2 with highpass filtering recording.abf.CH1_patch = highpass(recording.abf.CH1_patch,10,10000);
% for 10/13/2020 0009 use 100, 2.2 with highpass filtering recording.abf.CH1_patch = highpass(recording.abf.CH1_patch,10,10000);
% for 10/13/2020 0013 use 100, .5 with highpass filtering recording.abf.CH1_patch = highpass(recording.abf.CH1_patch,10,10000);


% for 10/15/2020 0000 use 100, .8 with highpass filtering recording.abf.CH1_patch = highpass(recording.abf.CH1_patch,10,10000);
% OLD for 10/15/2020 0001 use 100, 1.6 with highpass filtering recording.abf.CH1_patch = highpass(recording.abf.CH1_patch,10,10000);
% NEW for 10/15/2020 0001 use 90, 1.4 with highpass filtering recording.abf.CH1_patch = highpass(recording.abf.CH1_patch,10,10000);


% for 10/15/2020 0002 and 0003 use 100, 1.4 with highpass filtering recording.abf.CH1_patch = highpass(recording.abf.CH1_patch,10,10000);
% for 10/16/2020 0000 use 100, .4 with highpass filtering recording.abf.CH1_patch = highpass(recording.abf.CH1_patch,10,10000);

function [recording_out]=add_spike_to_recording(recording,minpeakdist,minpeakh)


% filter then find spikes
% added for 9/17/2019 0003
%recording.abf.CH1_patch_filtered = highpass(recording.abf.CH1_patch,100,10000);
recording.abf.CH1_patch_filtered = highpass(recording.abf.CH1_patch,10,10000);

%recording.abf.CH1_patch_filtered = recording.abf.CH1_patch;

[locs pk] = peakseek(recording.abf.CH1_patch_filtered,minpeakdist,minpeakh);

q = zeros(1,length(recording.abf.CH1_patch_filtered));
q(locs)=1;

recording.abf.CH1_patch_spikes = q;

% this convolution does not preserve the area under the curve just the max
window = 10000; %1 sec
w = gausswin(window); 
y = filter(w,1,recording.abf.CH1_patch_spikes);

y = [ y((window/2)+1:end), NaN(1,window/2)];

recording.abf.CH1_patch_spikes_conv = y;




% this was added on 9/25/2020 and not yet applied to older data
% applied manually to:
% 2020_09_17_0001_spikes.mat
% 2020_09_17_0000_spikes.mat
% 2020_09_15_0000_spikes.mat
% 2020_09_09_0000_spikes.mat
% 2020_09_09_0001_spikes.mat
% 2019_09_17_0003_spikes.mat



window = 1500; %150 msec
y = smooth(recording.abf.CH1_patch_spikes,window);
qq = recording.abf.CH1_patch;
[a b] = find(y >0);
qq(a) = NaN;
recording.abf.CH1_patch_spikes_removed = qq;




% this convolution preserves the area
window = 50000; %5 sec
w = gausswin(window); 
y = filter(w./(sum(w)),1,recording.abf.CH1_patch_spikes);

y = [ y((window/2)+1:end), NaN(1,window/2)];

recording.abf.CH1_patch_spikes_conv_area = y;
recording.abf.CH1_patch_spikes_conv_area = recording.abf.CH1_patch_spikes_conv_area';


window = 50000; %5 sec

y = filter((1/window)*ones(1,window),1,recording.abf.CH1_patch_spikes);
y = [ y((window/2)+1:end), NaN(1,window/2)];

recording.abf.CH1_patch_spikes_conv_area_rect = y;

% this line of code was in the pre 2020 code and probably made the rect
% convolution equal to the gaussian one
%recording.abf.CH1_patch_spikes_conv_area_rect = recording.abf.CH1_patch_spikes_conv_area';
recording.abf.CH1_patch_spikes_conv_area_rect = recording.abf.CH1_patch_spikes_conv_area_rect';





recording.abf.CH1_patch_spikes = recording.abf.CH1_patch_spikes';
recording.abf.CH1_patch_spikes_conv = recording.abf.CH1_patch_spikes_conv';






% recording.abf.CH1_patch= recording.abf.CH1_patch(1:end-100000);
% recording.abf.CH1_patch_spikes_removed= recording.abf.CH1_patch_spikes_removed(1:end-100000);
% recording.abf.CH1_patch_spikes= recording.abf.CH1_patch_spikes(1:end-100000);
% recording.abf.CH1_patch_spikes_conv= recording.abf.CH1_patch_spikes_conv(1:end-100000);
% recording.abf.Time_s = recording.abf.Time_s(1:end-100000);
% recording.abf.sucrose = recording.abf.sucrose(1:end-100000);

recording_out = recording;

end

% code to take a look at the spikes
% figure; hold on;
% plot(recording_out.abf.Time_s, recording_out.abf.CH1_patch);
% [a b] = find(recording_out.abf.CH1_patch_spikes >0);
% scatter(recording_out.abf.Time_s(a), recording_out.abf.CH1_patch(a),5);
 
